<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de bord — Security App</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css"
      integrity="sha512-v/w6hL8R/UXuNkXgaBxKuXuvM8tsht7+3V6IPhvUW6tI9GOrBRQayGKytQDnaGxpoWl0zIYzYlOygwaiA5e9Yw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        margin-top: 4rem;
      }

      .container {
        max-width: 960px;
      }

      .card {
        border: 1px solid #dcdcdc;
        border-radius: 4px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      pre {
        background: #f5f5f5;
        padding: 1rem;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <header
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <div>
          <h1>Bonjour <%= user.username %> !</h1>
          <p>
            Vous êtes connecté avec le rôle <strong><%= user.role %></strong>.
          </p>
        </div>
        <form method="post" action="/logout">
          <button type="submit" class="button-outline">Se déconnecter</button>
        </form>
      </header>

      <section class="card">
        <h2>Détails de la session</h2>
        <ul>
          <li><strong>Identifiant</strong> : <%= user.id %></li>
          <% if (user.email) { %>
          <li><strong>Email</strong> : <%= user.email %></li>
          <% } %>
          <li><strong>Dernière activité</strong> : <%= lastActivity %></li>
        </ul>
      </section>

      <% if (user.role === 'Admin') { %>
      <section class="card">
        <h2>Créer un nouvel utilisateur</h2>
        <form method="post" action="/api/users" id="create-user-form">
          <div class="row">
            <div class="column">
              <label for="new-username">Nom d'utilisateur</label>
              <input type="text" id="new-username" name="username" required />
            </div>
            <div class="column">
              <label for="new-email">Email</label>
              <input type="email" id="new-email" name="email" required />
            </div>
          </div>

          <label for="new-password">Mot de passe</label>
          <input type="password" id="new-password" name="password" required />

          <label for="new-age">Âge</label>
          <input
            type="number"
            id="new-age"
            name="age"
            min="13"
            max="120"
            required
          />

          <label for="new-role">Rôle</label>
          <select id="new-role" name="role">
            <option value="Viewer">Lecteur</option>
            <option value="Editor">Éditeur</option>
            <option value="Admin">Administrateur</option>
          </select>

          <button type="submit">Créer l'utilisateur</button>
        </form>

        <pre><code id="api-response">L'appel à l'API affichera la réponse JSON ici.</code></pre>
      </section>
      <% } %>
    </main>

    <% if (user.role === 'Admin') { %>
    <script>
      const form = document.getElementById("create-user-form");
      form?.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        const responseContainer = document.getElementById("api-response");
        responseContainer.textContent = "Envoi en cours...";

        try {
          const res = await fetch("/api/users", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          responseContainer.textContent = JSON.stringify(data, null, 2);
          if (res.ok) {
            form.reset();
          }
        } catch (err) {
          responseContainer.textContent = JSON.stringify(
            { error: "Une erreur est survenue", details: err.message },
            null,
            2
          );
        }
      });
    </script>
    <% } %>
  </body>
</html>
